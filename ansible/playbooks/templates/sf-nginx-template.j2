server {
  listen {{ item.listen_port }};
  listen [::]:{{ item.listen_port }};
{% if item.static is defined %}
  root /var/www/{{ item.name }}/html;
  index index.html;
{% endif %}
{% if client_domain is defined %}
  server_name {{ item.name }}.{{ client_domain }};
{% else %}
  server_name _;
{% endif %}
{% if item.static is not defined %}
  location / {
    # try_files $uri $uri/ =404;
    proxy_pass http://{{ item.ip }}{{ item.port }};
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }
{% else %}
  location / {
          try_files $uri $uri/ =404;
  }

  location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
          access_log off;
          expires max;
  }
{% endif %}
}